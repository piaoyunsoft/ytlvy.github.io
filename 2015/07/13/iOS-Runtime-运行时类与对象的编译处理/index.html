<!doctype html>
<html class="theme-next use-motion ">
<head>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="notes for study" />



  <meta name="keywords" content="IOS,runtime," />



  <link rel="alternate" href="/atom.xml" title="Yt's Blog" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    analytics: {
      google: ''
    },
    sidebar: 'post'
  };
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b8a916e09c6b39221eb089c8ad75ede9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <title> iOS Runtime 运行时类与对象的编译处理 // Yt's Blog </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Yt's Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首頁
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          分類
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          關於
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          歸檔
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          標籤
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              iOS Runtime 运行时类与对象的编译处理
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-07-13
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分類於
            
              <a href="/categories/IOS/">IOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/07/13/iOS-Runtime-运行时类与对象的编译处理/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/07/13/iOS-Runtime-运行时类与对象的编译处理/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <h2 id="iOS_Runtime运行时类与对象的编译处理">iOS Runtime运行时类与对象的编译处理</h2><p>Objective-C语言是一门动态语言，它将很多静态语言在编译和链接时期做的事放到了运行时来处理。这种动态语言的优势在于：我们写代码时更具灵活性，如我们可以把消息转发给我们想要的对象，或者随意交换一个方法的实现等。<br>这种特性意味着<code>Objective-C</code>不仅需要一个编译器，还需要一个运行时系统来执行编译的代码。对于Objective-C来说，这个运行时系统就像一个操作系统一样：它让所有的工作可以正常的运行。这个运行时系统即Objc Runtime。Objc Runtime其实是一个Runtime库，它基本上是用C和汇编写的，这个库使得C语言有了面向对象的能力。</p>
<p>Runtime库主要做下面几件事：</p>
<ol>
<li>封装：在这个库中，对象可以用C语言中的结构体表示，而方法可以用C函数来实现，另外再加上了一些额外的特性。这些结构体和函数被runtime函数封装后，我们就可以在程序运行时创建，检查，修改类、对象和它们的方法了。</li>
<li>找出方法的最终执行代码：当程序执行[object doSomething]时，会向消息接收者(object)发送一条消息(doSomething)，runtime会根据消息接收者是否能响应该消息而做出不同的反应。这将在后面详细介绍。</li>
</ol>
<p>&nbsp;&nbsp;&nbsp;&nbsp;Objective-C runtime目前有两个版本：Modern runtime和Legacy runtime。Modern Runtime 覆盖了64位的Mac OS X Apps，还有 iOS Apps，Legacy Runtime 是早期用来给32位 Mac OS X Apps 用的，也就是可以不用管就是了。<br>在这一系列文章中，我们将介绍runtime的基本工作原理，以及如何利用它让我们的程序变得更加灵活。在本文中，我们先来介绍一下类与对象，这是面向对象的基础，我们看看在Runtime中，类是如何实现的。<br><a id="more"></a></p>
<h3 id="类与对象基础数据结构">类与对象基础数据结构</h3><h4 id="Class">Class</h4><p>Objective-C类是由Class类型来表示的，它实际上是一个指向objc_class结构体的指针。它的定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br></pre></td></tr></table></figure></p>
<p>查看objc/runtime.h中objc_class结构体的定义如下：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_<span class="built_in">AVAILABILITY</span>;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#if !__OBJC2__</span></span><br><span class="line">    Class super_class                       OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 父类</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                        OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 类名</span></span><br><span class="line">    <span class="keyword">long</span> version                            OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 类的版本信息，默认为0</span></span><br><span class="line">    <span class="keyword">long</span> info                               OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 类信息，供运行期使用的一些位标识</span></span><br><span class="line">    <span class="keyword">long</span> instance_size                      OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 该类的实例变量大小</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars            OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 该类的成员变量链表</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method_list **methodLists   OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 方法定义的链表</span></span><br><span class="line">    <span class="keyword">struct</span> objc_cache *cache                OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 方法缓存</span></span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols    OBJC2_UN<span class="built_in">AVAILABLE</span>;  <span class="comment">// 协议链表</span></span><br><span class="line"><span class="preprocessor">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br></pre></td></tr></table></figure></p>
<p>在这个定义中，下面几个字段是我们感兴趣的</p>
<ol>
<li>isa：需要注意的是在Objective-C中，所有的类自身也是一个对象，这个对象的Class里面也有一个isa指针，它指向metaClass(元类)，我们会在后面介绍它。</li>
<li>super_class：指向该类的父类，如果该类已经是最顶层的根类(如NSObject或NSProxy)，则super_class为NULL。</li>
<li>cache：用于缓存最近使用的方法。一个接收者对象接收到一个消息时，它会根据isa指针去查找能够响应这个消息的对象。在实际使用中，这个对象只有一部分方法是常用的，很多方法其实很少用或者根本用不上。这种情况下，如果每次消息来时，我们都是methodLists中遍历一遍，性能势必很差。这时，cache就派上用场了。在我们每次调用过一个方法后，这个方法就会被缓存到cache列表中，下次调用的时候runtime就会优先去cache中查找，如果cache没有，才去methodLists中查找方法。这样，对于那些经常用到的方法的调用，但提高了调用的效率。</li>
<li>version：我们可以使用这个字段来提供类的版本信息。这对于对象的序列化非常有用，它可是让我们识别出不同类定义版本中实例变量布局的改变</li>
</ol>
<p>针对cache，我们用下面例子来说明其执行过程：<br><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSArray *array = <span class="comment">[<span class="comment">[NSArray alloc]</span> init]</span>;</span><br></pre></td></tr></table></figure></p>
<p>其流程是：</p>
<ol>
<li>[NSArray alloc]先被执行。因为NSArray没有+alloc方法，于是去父类NSObject去查找。</li>
<li>检测NSObject是否响应+alloc方法，发现响应，于是检测NSArray类，并根据其所需的内存空间大小开始分配内存空间，然后把isa指针指向NSArray类。同时，+alloc也被加进cache列表里面。</li>
<li>接着，执行-init方法，如果NSArray响应该方法，则直接将其加入cache；如果不响应，则去父类查找。</li>
<li>在后期的操作中，如果再以[[NSArray alloc] init]这种方式来创建数组，则会直接从cache中取出相应的方法，直接调用。</li>
</ol>
<blockquote>
<p>备注上面的说法是错误的, NSArray 采用了类簇来实现, alloc 之后生成的<code>__NSPlacehodlerArray</code>不是NSArray</p>
</blockquote>
<h4 id="objc_object与id">objc_object与id</h4><p>objc_object是表示一个类的实例的结构体，它的定义如下(objc/objc.h)：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class isa  OBJC_ISA_<span class="built_in">AVAILABILITY</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这个结构体只有一个字体，即指向其类的isa指针。这样，当我们向一个Objective-C对象发送消息时，运行时库会根据实例对象的isa指针找到这个实例对象所属的类。Runtime库会在类的方法列表及父类的方法列表中去寻找与消息对应的selector指向的方法。找到后即运行这个方法。<br>当创建一个特定类的实例对象时，分配的内存包含一个objc_object数据结构，然后是类的实例变量的数据。NSObject类的alloc和allocWithZone:方法使用函数class_createInstance来创建objc_object数据结构。<br>另外还有我们常见的id，它是一个objc_object结构类型的指针。它的存在可以让我们实现类似于C++中泛型的一些操作。该类型的对象可以转换为任何一种对象，有点类似于C语言中void *指针类型的作用</p>
<h4 id="objc_cache">objc_cache</h4><p>上面提到了objc_class结构体中的cache字段，它用于缓存调用过的方法。这个字段是一个指向objc_cache结构体的指针，其定义如下<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_cache &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">    Method buckets[<span class="number">1</span>]                                        OBJC2_UN<span class="built_in">AVAILABLE</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>该结构体的字段描述如下：</p>
<ol>
<li>mask：一个整数，指定分配的缓存bucket的总数。在方法查找过程中，Objective-C runtime使用这个字段来确定开始线性查找数组的索引位置。指向方法selector的指针与该字段做一个AND位操作(index = (mask &amp; selector))。这可以作为一个简单的hash散列算法。</li>
<li>occupied：一个整数，指定实际占用的缓存bucket的总数。</li>
<li>buckets：指向Method数据结构指针的数组。这个数组可能包含不超过mask+1个元素。需要注意的是，指针可能是NULL，表示这个缓存bucket没有被占用，另外被占用的bucket可能是不连续的。这个数组可能会随着时间而增长。</li>
</ol>
<h4 id="元类(Meta_Class)">元类(Meta Class)</h4><p>上面我们提到，所有的类自身也是一个对象，我们可以向这个对象发送消息(即调用类方法)。如：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSArray *<span class="built_in">array</span> = [NSArray <span class="built_in">array</span>];</span><br></pre></td></tr></table></figure></p>
<p>这个例子中，<code>+array</code>消息发送给了<code>NSArray</code>类，而这个<code>NSArray</code>也是一个对象。既然是对象，那么它也是一个<code>objc_object</code>指针，它包含一个指向其类的一个<code>isa</code>指针。那么这些就有一个问题了，这个isa指针指向什么呢？为了调用+array方法，这个类的isa指针必须指向一个包含这些类方法的一个<code>objc_class</code>结构体。这就引出了<code>meta-class</code>的概念</p>
<p>meta-class是一个类对象的类。当我们向一个对象发送消息时，runtime会在这个对象所属的这个类的方法列表中查找方法；而向一个类发送消息时，会在这个类的meta-class的方法列表中查找。</p>
<p>meta-class之所以重要，是因为它存储着一个类的所有类方法。每个类都会有一个单独的meta-class，因为每个类的类方法基本不可能完全相同。<br>再深入一下，meta-class也是一个类，也可以向它发送一个消息，那么它的isa又是指向什么呢？为了不让这种结构无限延伸下去，Objective-C的设计者让所有的meta-class的isa指向基类的meta-class，以此作为它们的所属类。即，任何NSObject继承体系下的meta-class都使用NSObject的meta-class作为自己的所属类，而基类的meta-class的isa指针是指向它自己。这样就形成了一个完美的闭环。</p>
<p>通过上面的描述，再加上对objc_class结构体中super_class指针的分析，我们就可以描绘出类及相应meta-class类的一个继承体系了，如下图所示：<br><img src="http://img.blog.csdn.net/20150317161312799" alt=""></p>
<p>对于NSObject继承体系来说，其实例方法对体系中的所有实例、类和meta-class都是有效的；而类方法对于体系内的所有类和meta-class都是有效的。<br>讲了这么多，我们还是来写个例子吧：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> TestMetaClass(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"This objcet is %p"</span>, <span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Class is %@, super class is %@"</span>, [<span class="keyword">self</span> class], [<span class="keyword">self</span> superclass]);</span><br><span class="line">    </span><br><span class="line">    Class currentClass = [<span class="keyword">self</span> class];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Following the isa pointer %d times gives %p, %@"</span>, i, currentClass, <span class="built_in">NSStringFromClass</span>(currentClass));</span><br><span class="line">        <span class="keyword">if</span> (class_isMetaClass(currentClass)) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"----current class is MetaClass"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        currentClass = object_getClass(currentClass);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"NSObject's class is %p"</span>, [<span class="built_in">NSObject</span> class]);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"NSObject's meta class is %p"</span>, object_getClass([<span class="built_in">NSObject</span> class]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark -</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Test</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)ex_registerClassPair &#123;</span><br><span class="line"></span><br><span class="line">    Class newClass = objc_allocateClassPair([<span class="built_in">NSError</span> class], <span class="string">"TestClass"</span>, <span class="number">0</span>);</span><br><span class="line">    class_addMethod(newClass, <span class="keyword">@selector</span>(testMetaClass), (IMP)TestMetaClass, <span class="string">"v@:"</span>);</span><br><span class="line">    objc_registerClassPair(newClass);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> instance = [[newClass alloc] initWithDomain:<span class="string">@"some domain"</span> code:<span class="number">0</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">    [instance performSelector:<span class="keyword">@selector</span>(testMetaClass)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>这个例子是在运行时创建了一个NSError的子类TestClass，然后为这个子类添加一个方法testMetaClass，这个方法的实现是TestMetaClass函数。<br>运行后，打印结果是<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>6 iTest[<span class="number">1788:31341</span>] This objcet is 0x7fa<span class="number">281d9e29</span>0</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>6 iTest[<span class="number">1788:31341</span>] Class is TestClass, super class is NSError</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>6 iTest[<span class="number">1788:31341</span>] Following the isa pointer 0 times gives 0x7fa<span class="number">281d9e59</span>0, TestClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>7 iTest[<span class="number">1788:31341</span>] Following the isa pointer 1 times gives 0x7fa<span class="number">281d9b89</span>0, TestClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>7 iTest[<span class="number">1788:31341</span>] ----current class is MetaClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>7 iTest[<span class="number">1788:31341</span>] Following the isa pointer 2 times gives <span class="number">0x10a0c119</span>8, NSObject</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>7 iTest[<span class="number">1788:31341</span>] ----current class is MetaClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>7 iTest[<span class="number">1788:31341</span>] Following the isa pointer 3 times gives <span class="number">0x10a0c119</span>8, NSObject</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>8 iTest[<span class="number">1788:31341</span>] ----current class is MetaClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>8 iTest[<span class="number">1788:31341</span>] Following the isa pointer 4 times gives <span class="number">0x10a0c119</span>8, NSObject</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>8 iTest[<span class="number">1788:31341</span>] ----current class is MetaClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>9 iTest[<span class="number">1788:31341</span>] Following the isa pointer 5 times gives <span class="number">0x10a0c119</span>8, NSObject</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>9 iTest[<span class="number">1788:31341</span>] ----current class is MetaClass</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>9 iTest[<span class="number">1788:31341</span>] NSObject's class is <span class="number">0x10a0c117</span>0</span><br><span class="line"><span class="number">2015-07-10</span> <span class="number">14:47:14.32</span>9 iTest[<span class="number">1788:31341</span>] NSObject's meta class is <span class="number">0x10a0c119</span>8</span><br></pre></td></tr></table></figure></p>
<p>我们在for循环中，我们通过object_getClass来获取对象的isa，并将其打印出来，依此一直回溯到NSObject的meta-class。可以分析得出:</p>
<ol>
<li>NSObject 的MetaClass 为RootMetaClass(0x10a0c1198)</li>
<li>RootMetaClass的元类为它自身</li>
<li>TestClass(0x7fa281d9e590) 的元类为TestClass(0x7fa281d9b890)—此类为MetaClass</li>
<li>TestClass(0x7fa281d9b890)的元类为RootMetaClass(0x10a0c1198)</li>
</ol>
<h4 id="类与对象操作函数">类与对象操作函数</h4><p>runtime提供了大量的函数来操作类与对象。类的操作方法大部分是以class为前缀的，而对象的操作方法大部分是以objc或object_为前缀。下面我们将根据这些方法的用途来分类讨论这些方法的使用。</p>
<h4 id="类相关操作函数">类相关操作函数</h4><p>我们可以回过头去看看objc_class的定义，runtime提供的操作类的方法主要就是针对这个结构体中的各个字段的。下面我们分别介绍这一些的函数。并在最后以实例来演示这些函数的具体用法。</p>
<h4 id="类名(name)">类名(name)</h4><p>类名操作的函数主要有:<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> char * class_getName ( <span class="class"><span class="keyword">Class</span> <span class="title">cls</span> );</span></span><br></pre></td></tr></table></figure></p>
<p>对于class_getName函数，如果传入的cls为Nil，则返回一个空字符串。</p>
<h4 id="父类(super_class)和元类(meta-class)">父类(super_class)和元类(meta-class)</h4><p>父类和元类操作的函数主要有：<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 获取类的父类</span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">class_getSuperclass</span> ( <span class="title">Class</span> <span class="title">cls</span> );</span></span><br><span class="line"></span><br><span class="line">// 判断给定的<span class="class"><span class="keyword">Class</span>是否是一个元类</span></span><br><span class="line">BOOL class_isMetaClass ( <span class="class"><span class="keyword">Class</span> <span class="title">cls</span> );</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>class_getSuperclass函数，当cls为Nil或者cls为根类时，返回Nil。不过通常我们可以使用NSObject类的superclass方法来达到同样的目的。</li>
<li>class_isMetaClass函数，如果是cls是元类，则返回YES；如果否或者传入的cls为Nil，则返回NO。</li>
</ul>
<h4 id="实例变量大小(instance_size)">实例变量大小(instance_size)</h4><p>实例变量大小操作的函数有：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size_t class_getInstanceSize <span class="list">( <span class="keyword">Class</span> cls )</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="成员变量(ivars)及属性">成员变量(ivars)及属性</h4><p>在objc_class中，所有的成员变量、属性的信息是放在链表ivars中的。ivars是一个数组，数组中每个元素是指向Ivar(变量信息)的指针。runtime提供了丰富的函数来操作这一字段。大体上可以分为以下几类：<br>1 成员变量操作函数，主要包含以下函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取类中指定名称实例成员变量的信息</span></span><br><span class="line"><span class="function">Ivar <span class="title">class_getInstanceVariable</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类成员变量的信息</span></span><br><span class="line"><span class="function">Ivar <span class="title">class_getClassVariable</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加成员变量</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_addIvar</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, size_t size, uint8_t alignment, <span class="keyword">const</span> <span class="keyword">char</span> *types )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取整个成员变量列表</span></span><br><span class="line">Ivar * class_copyIvarList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</span><br></pre></td></tr></table></figure></p>
<ul>
<li>class_getInstanceVariable函数，它返回一个指向包含name指定的成员变量信息的objc_ivar结构体的指针(Ivar)。</li>
<li>class_getClassVariable函数，目前没有找到关于Objective-C中类变量的信息，一般认为Objective-C不支持类变量。注意，返回的列表不包含父类的成员变量和属性。</li>
<li>Objective-C不支持往已存在的类中添加实例变量，因此不管是系统库提供的提供的类，还是我们自定义的类，都无法动态添加成员变量。但如果我们通过运行时来创建一个类的话，又应该如何给它添加成员变量呢？这时我们就可以使用class_addIvar函数了。不过需要注意的是，这个方法只能在objc_allocateClassPair函数与objc_registerClassPair之间调用。另外，这个类也不能是元类。成员变量的按字节最小对齐量是<code>1&lt;&lt;alignment</code>。这取决于ivar的类型和机器的架构。如果变量的类型是指针类型，则传递log2(sizeof(pointer_type))。</li>
<li>class_copyIvarList函数，它返回一个指向成员变量信息的数组，数组中每个元素是指向该成员变量信息的objc_ivar结构体的指针。这个数组不包含在父类中声明的变量。outCount指针返回数组的大小。需要注意的是，我们必须使用free()来释放这个数组。</li>
</ul>
<p>2 属性操作函数，主要包含以下函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取指定的属性</span></span><br><span class="line"><span class="keyword">objc_property_t</span> class_getProperty ( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取属性列表</span></span><br><span class="line"><span class="keyword">objc_property_t</span> * class_copyPropertyList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为类添加属性</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_addProperty</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换类的属性</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_replaceProperty</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> objc_property_attribute_t *attributes, <span class="keyword">unsigned</span> <span class="keyword">int</span> attributeCount )</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>这一种方法也是针对ivars来操作，不过只操作那些是属性的值。我们在后面介绍属性时会再遇到这些函数。</p>
<p>3 在MAC OS X系统中，我们可以使用垃圾回收器。runtime提供了几个函数来确定一个对象的内存区域是否可以被垃圾回收器扫描，以处理strong/weak引用。这几个函数定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> * class_getIvarLayout ( Class cls );</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_setIvarLayout</span> <span class="params">( Class cls, <span class="keyword">const</span> uint8_t *layout )</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span> * class_getWeakIvarLayout ( Class cls );</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_setWeakIvarLayout</span> <span class="params">( Class cls, <span class="keyword">const</span> uint8_t *layout )</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>但通常情况下，我们不需要去主动调用这些方法；在调用objc_registerClassPair时，会生成合理的布局。在此不详细介绍这些函数</p>
<h4 id="方法(methodLists)">方法(methodLists)</h4><p>方法操作主要有以下函数：<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加方法</span></span><br><span class="line">BOOL class_addMethod ( <span class="keyword">Class</span> cls, SEL name, IMP imp, <span class="keyword">const</span> char *types );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取实例方法</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">class_getInstanceMethod</span> <span class="params">( <span class="keyword">Class</span> cls, SEL name )</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类方法</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> <span class="title">class_getClassMethod</span> <span class="params">( <span class="keyword">Class</span> cls, SEL name )</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有方法的数组</span></span><br><span class="line"><span class="function"><span class="keyword">Method</span> * <span class="title">class_copyMethodList</span> <span class="params">( <span class="keyword">Class</span> cls, unsigned int *outCount )</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 替代方法的实现</span></span><br><span class="line">IMP class_replaceMethod ( <span class="keyword">Class</span> cls, SEL name, IMP imp, <span class="keyword">const</span> char *types );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回方法的具体实现</span></span><br><span class="line">IMP class_getMethodImplementation ( <span class="keyword">Class</span> cls, SEL name );</span><br><span class="line">IMP class_getMethodImplementation_stret ( <span class="keyword">Class</span> cls, SEL name );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类实例是否响应指定的selector</span></span><br><span class="line">BOOL class_respondsToSelector ( <span class="keyword">Class</span> cls, SEL sel );</span><br></pre></td></tr></table></figure></p>
<p>class_addMethod的实现会覆盖父类的方法实现，但不会取代本类中已存在的实现，如果本类中包含一个同名的实现，则函数会返回NO。如果要修改已存在实现，可以使用method_setImplementation。一个Objective-C方法是一个简单的C函数，它至少包含两个参数—self和_cmd。所以，我们的实现函数(IMP参数指向的函数)至少需要两个参数，如下所示：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> myMethodIMP(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// implementation ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>与成员变量不同的是，我们可以为类动态添加方法，不管这个类是否已存在。<br>另外，参数types是一个描述传递给方法的参数类型的字符数组，这就涉及到类型编码，我们将在后面介绍</p>
<p>class_getInstanceMethod、class_getClassMethod函数，与class_copyMethodList不同的是，这两个函数都会去搜索父类的实现</p>
<p>class_copyMethodList函数，返回包含所有实例方法的数组，如果需要获取类方法，则可以使用class_copyMethodList(object_getClass(cls), &amp;count)(一个类的实例方法是定义在元类里面)。该列表不包含父类实现的方法。outCount参数返回方法的个数。在获取到列表后，我们需要使用free()方法来释放它。</p>
<p>class_replaceMethod函数，该函数的行为可以分为两种：如果类中不存在name指定的方法，则类似于class_addMethod函数一样会添加方法；如果类中已存在name指定的方法，则类似于method_setImplementation一样替代原方法的实现。</p>
<p>class_getMethodImplementation函数，该函数在向类实例发送消息时会被调用，并返回一个指向方法实现函数的指针。这个函数会比method_getImplementation(class_getInstanceMethod(cls, name))更快。返回的函数指针可能是一个指向runtime内部的函数，而不一定是方法的实际实现。例如，如果类实例无法响应selector，则返回的函数指针将是运行时消息转发机制的一部分。</p>
<p>class_respondsToSelector函数，我们通常使用NSObject类的respondsToSelector:或instancesRespondToSelector:方法来达到相同目的。</p>
<h4 id="协议(objc_protocol_list)">协议(objc_protocol_list)</h4><p>协议相关的操作包含以下函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加协议</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_addProtocol</span> <span class="params">( Class cls, Protocol *protocol )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回类是否实现指定的协议</span></span><br><span class="line"><span class="function">BOOL <span class="title">class_conformsToProtocol</span> <span class="params">( Class cls, Protocol *protocol )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回类实现的协议列表</span></span><br><span class="line">Protocol * class_copyProtocolList ( Class cls, <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</span><br></pre></td></tr></table></figure></p>
<ul>
<li>class_conformsToProtocol函数可以使用NSObject类的conformsToProtocol:方法来替代。</li>
<li>class_copyProtocolList函数返回的是一个数组，在使用后我们需要使用free()手动释放。</li>
</ul>
<h4 id="版本(version)">版本(version)</h4><p>版本相关的操作包含以下函数：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取版本号</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">class_getVersion</span> <span class="params">( Class cls )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置版本号</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">class_setVersion</span> <span class="params">( Class cls, <span class="keyword">int</span> version )</span></span>;</span><br></pre></td></tr></table></figure></p>
<h4 id="其它">其它</h4><p>runtime还提供了两个函数来供CoreFoundation的tool-free bridging使用，即：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Class <span class="title">objc_getFutureClass</span> <span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_setFutureClass</span> <span class="params">( Class cls, <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br></pre></td></tr></table></figure></p>
<h4 id="实例(Example)">实例(Example)</h4><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line">/-----------------------------------------------------------</span><br><span class="line"><span class="comment">// MyClass.h</span></span><br><span class="line"></span><br><span class="line">@interface MyClass : NSObject </span><br><span class="line"></span><br><span class="line">@property <span class="params">(nonatomic, strong)</span> NSArray <span class="built_in">*</span>array;</span><br><span class="line"></span><br><span class="line">@property <span class="params">(nonatomic, copy)</span> NSString <span class="built_in">*</span>string;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>method1;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>method2;</span><br><span class="line"></span><br><span class="line">+ <span class="params">(void)</span>classMethod1;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------------</span></span><br><span class="line"><span class="comment">// MyClass.m</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">#</span><span class="built_in">import</span> <span class="string">"MyClass.h"</span></span><br><span class="line"></span><br><span class="line">@interface MyClass <span class="params">()</span> &#123;</span><br><span class="line">    NSInteger       _instance1;</span><br><span class="line"></span><br><span class="line">    NSString    <span class="built_in">*</span>   _instance2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@property <span class="params">(nonatomic, assign)</span> NSUInteger integer;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>method3WithArg1:<span class="params">(NSInteger)</span>arg1 arg2:<span class="params">(NSString *)</span>arg2;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation MyClass</span><br><span class="line"></span><br><span class="line">+ <span class="params">(void)</span>classMethod1 &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>method1 &#123;</span><br><span class="line">    NSLog<span class="params">(@<span class="string">"call method method1"</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>method2 &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- <span class="params">(void)</span>method3WithArg1:<span class="params">(NSInteger)</span>arg1 arg2:<span class="params">(NSString *)</span>arg2 &#123;</span><br><span class="line"></span><br><span class="line">    NSLog<span class="params">(@<span class="string">"arg1 : %ld, arg2 : %@"</span>, arg1, arg2)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------------------</span></span><br><span class="line"><span class="comment">// main.h</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">#</span><span class="built_in">import</span> <span class="string">"MyClass.h"</span></span><br><span class="line"><span class="built_in">#</span><span class="built_in">import</span> <span class="string">"MySubClass.h"</span></span><br><span class="line"><span class="built_in">#</span><span class="built_in">import</span> </span><br><span class="line"></span><br><span class="line">int main<span class="params">(int argc, const char * argv[])</span> &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line"></span><br><span class="line">        MyClass <span class="built_in">*</span>myClass = [[MyClass alloc] init];</span><br><span class="line">        unsigned int outCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        Class cls = myClass.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 类名</span></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"class name: %s"</span>, class_getName<span class="params">(cls)</span>)</span>;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 父类</span></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"super class name: %s"</span>, class_getName<span class="params">(class_getSuperclass<span class="params">(cls)</span>)</span>)</span>;</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 是否是元类</span></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"MyClass is %@ a meta-class"</span>, <span class="params">(class_isMetaClass<span class="params">(cls)</span> ? @<span class="string">""</span> : @<span class="string">"not"</span>)</span>)</span>;</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        Class meta_class = objc_getMetaClass<span class="params">(class_getName<span class="params">(cls)</span>)</span>;</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"%s's meta-class is %s"</span>, class_getName<span class="params">(cls)</span>, class_getName<span class="params">(meta_class)</span>)</span>;</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 变量实例大小</span></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"instance size: %zu"</span>, class_getInstanceSize<span class="params">(cls)</span>)</span>;</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 成员变量</span></span><br><span class="line">        Ivar <span class="built_in">*</span>ivars = class_copyIvarList<span class="params">(cls, &amp;outCount)</span>;</span><br><span class="line">        <span class="keyword">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; outCount; i++)</span> &#123;</span><br><span class="line">            Ivar ivar = ivars[i];</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"instance variable's name: %s at index: %d"</span>, ivar_getName<span class="params">(ivar)</span>, i)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free<span class="params">(ivars)</span>;</span><br><span class="line"></span><br><span class="line">        Ivar string = class_getInstanceVariable<span class="params">(cls, <span class="string">"_string"</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="params">(string != NULL)</span> &#123;</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"instace variable %s"</span>, ivar_getName<span class="params">(string)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 属性操作</span></span><br><span class="line">        objc_property_t <span class="built_in">*</span> properties = class_copyPropertyList<span class="params">(cls, &amp;outCount)</span>;</span><br><span class="line">        <span class="keyword">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; outCount; i++)</span> &#123;</span><br><span class="line">            objc_property_t property = properties[i];</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"property's name: %s"</span>, property_getName<span class="params">(property)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free<span class="params">(properties)</span>;</span><br><span class="line"></span><br><span class="line">        objc_property_t array = class_getProperty<span class="params">(cls, <span class="string">"array"</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="params">(array != NULL)</span> &#123;</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"property %s"</span>, property_getName<span class="params">(array)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方法操作</span></span><br><span class="line">        Method <span class="built_in">*</span>methods = class_copyMethodList<span class="params">(cls, &amp;outCount)</span>;</span><br><span class="line">        <span class="keyword">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; outCount; i++)</span> &#123;</span><br><span class="line">            Method method = methods[i];</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"method's signature: %s"</span>, method_getName<span class="params">(method)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        free<span class="params">(methods)</span>;</span><br><span class="line"></span><br><span class="line">        Method method1 = class_getInstanceMethod<span class="params">(cls, @selector<span class="params">(method1)</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="params">(method1 != NULL)</span> &#123;</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"method %s"</span>, method_getName<span class="params">(method1)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Method classMethod = class_getClassMethod<span class="params">(cls, @selector<span class="params">(classMethod1)</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="params">(classMethod != NULL)</span> &#123;</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"class method : %s"</span>, method_getName<span class="params">(classMethod)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"MyClass is%@ responsd to selector: method3WithArg1:arg2:"</span>, class_respondsToSelector<span class="params">(cls, @selector<span class="params">(method3WithArg1:arg2:)</span>)</span> ? @<span class="string">""</span> : @<span class="string">" not"</span>)</span>;</span><br><span class="line"></span><br><span class="line">        IMP imp = class_getMethodImplementation<span class="params">(cls, @selector<span class="params">(method1)</span>)</span>;</span><br><span class="line">        imp<span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 协议</span></span><br><span class="line">        Protocol <span class="built_in">*</span> __unsafe_unretained <span class="built_in">*</span> protocols = class_copyProtocolList<span class="params">(cls, &amp;outCount)</span>;</span><br><span class="line">        Protocol <span class="built_in">*</span> protocol;</span><br><span class="line">        <span class="keyword">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; outCount; i++)</span> &#123;</span><br><span class="line">            protocol = protocols[i];</span><br><span class="line">            NSLog<span class="params">(@<span class="string">"protocol name: %s"</span>, protocol_getName<span class="params">(protocol)</span>)</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"MyClass is%@ responsed to protocol %s"</span>, class_conformsToProtocol<span class="params">(cls, protocol)</span> ? @<span class="string">""</span> : @<span class="string">" not"</span>, protocol_getName<span class="params">(protocol)</span>)</span>;</span><br><span class="line"></span><br><span class="line">        NSLog<span class="params">(@<span class="string">"=========================================================="</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段程序的输出如下：<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.452</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="keyword">class</span> name: MyClass</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.453</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] ==========================================================</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.454</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] super <span class="keyword">class</span> name: NSObject</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.454</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] ==========================================================</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.454</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] MyClass <span class="keyword">is</span> <span class="keyword">not</span> a meta-<span class="keyword">class</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.454</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] ==========================================================</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.454</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] MyClass<span class="string">'s meta-class is MyClass</span><br><span class="line">2014-10-22 19:41:37.455 RuntimeTest[3189:156810] ==========================================================</span><br><span class="line">2014-10-22 19:41:37.455 RuntimeTest[3189:156810] instance size: 48</span><br><span class="line">2014-10-22 19:41:37.455 RuntimeTest[3189:156810] ==========================================================</span><br><span class="line">2014-10-22 19:41:37.455 RuntimeTest[3189:156810] instance variable'</span>s name: _instance1 at <span class="keyword">index</span>: <span class="number">0</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.455</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] instance variable<span class="string">'s name: _instance2 at index: 1</span><br><span class="line">2014-10-22 19:41:37.455 RuntimeTest[3189:156810] instance variable'</span>s name: _array at <span class="keyword">index</span>: <span class="number">2</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.455</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] instance variable<span class="string">'s name: _string at index: 3</span><br><span class="line">2014-10-22 19:41:37.463 RuntimeTest[3189:156810] instance variable'</span>s name: _integer at <span class="keyword">index</span>: <span class="number">4</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.463</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] instace variable _string</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.463</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] ==========================================================</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.463</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="keyword">property</span><span class="string">'s name: array</span><br><span class="line">2014-10-22 19:41:37.463 RuntimeTest[3189:156810] property'</span>s name: string</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.464</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="keyword">property</span><span class="string">'s name: integer</span><br><span class="line">2014-10-22 19:41:37.464 RuntimeTest[3189:156810] property array</span><br><span class="line">2014-10-22 19:41:37.464 RuntimeTest[3189:156810] ==========================================================</span><br><span class="line">2014-10-22 19:41:37.464 RuntimeTest[3189:156810] method'</span>s signature: method1</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.464</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> method2</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.464</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> method3WithArg1:arg2:</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.465</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> integer</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.465</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> setInteger:</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.465</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> <span class="keyword">array</span></span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.465</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> string</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.465</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> setString:</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.465</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> setArray:</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.466</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span>'<span class="title">s</span> <span class="title">signature</span>:</span> .cxx_destruct</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.466</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="function"><span class="keyword">method</span> <span class="title">method1</span></span><br><span class="line">2014-10-22 19:</span><span class="number">41</span>:<span class="number">37.466</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] <span class="keyword">class</span> <span class="function"><span class="keyword">method</span> :</span> classMethod1</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.466</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] MyClass <span class="keyword">is</span> responsd <span class="keyword">to</span> <span class="keyword">selector</span>: method3WithArg1:arg2:</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.467</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] call <span class="function"><span class="keyword">method</span> <span class="title">method1</span></span><br><span class="line">2014-10-22 19:</span><span class="number">41</span>:<span class="number">37.467</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] ==========================================================</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.467</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] protocol name: NSCopying</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.467</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] protocol name: NSCoding</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.467</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] MyClass <span class="keyword">is</span> responsed <span class="keyword">to</span> protocol NSCoding</span><br><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">22</span> <span class="number">19</span>:<span class="number">41</span>:<span class="number">37.468</span> RuntimeTest[<span class="number">3189</span>:<span class="number">156810</span>] ==========================================================</span><br></pre></td></tr></table></figure></p>
<h4 id="动态创建类和对象">动态创建类和对象</h4><p>runtime的强大之处在于它能在运行时创建类和对象。</p>
<h5 id="动态创建类">动态创建类</h5><p>动态创建类涉及到以下几个函数：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个新类和元类</span></span><br><span class="line"><span class="function">Class <span class="title">objc_allocateClassPair</span> <span class="params">( Class superclass, <span class="keyword">const</span> <span class="keyword">char</span> *name, size_t extraBytes )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁一个类及其相关联的类</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_disposeClassPair</span> <span class="params">( Class cls )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在应用中注册由objc_allocateClassPair创建的类</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">objc_registerClassPair</span> <span class="params">( Class cls )</span></span>;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>objc_allocateClassPair函数：如果我们要创建一个根类，则superclass指定为Nil。extraBytes通常指定为0，该参数是分配给类和元类对象尾部的索引ivars的字节数。 为了创建一个新类，我们需要调用objc_allocateClassPair。然后使用诸如class_addMethod，class_addIvar等函数来为新创建的类添加方法、实例变量和属性等。完成这些后，我们需要调用objc_registerClassPair函数来注册类，之后这个新类就可以在程序中使用了。<br>实例方法和实例变量应该添加到类自身上，而类方法应该添加到类的元类上。</p>
</li>
<li><p>objc_disposeClassPair函数用于销毁一个类，不过需要注意的是，如果程序运行中还存在类或其子类的实例，则不能调用针对类调用该方法<br>在前面介绍元类时，我们已经有接触到这几个函数了，在此我们再举个实例来看看这几个函数的使用。</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Class cls = objc_allocateClassPair<span class="params">(MyClass.class, <span class="string">"MySubClass"</span>, <span class="number">0</span>)</span>;</span><br><span class="line">class_addMethod<span class="params">(cls, @selector<span class="params">(submethod1)</span>, <span class="params">(IMP)</span>imp_submethod1, <span class="string">"v@:"</span>)</span>;</span><br><span class="line">class_replaceMethod<span class="params">(cls, @selector<span class="params">(method1)</span>, <span class="params">(IMP)</span>imp_submethod1, <span class="string">"v@:"</span>)</span>;</span><br><span class="line">class_addIvar<span class="params">(cls, <span class="string">"_ivar1"</span>, sizeof<span class="params">(NSString *)</span>, log<span class="params">(sizeof<span class="params">(NSString *)</span>)</span>, <span class="string">"i"</span>)</span>;</span><br><span class="line"></span><br><span class="line">objc_property_attribute_t type = &#123;<span class="string">"T"</span>, <span class="string">"@\"NSString\""</span>&#125;;</span><br><span class="line">objc_property_attribute_t ownership = &#123; <span class="string">"C"</span>, <span class="string">""</span> &#125;;</span><br><span class="line">objc_property_attribute_t backingivar = &#123; <span class="string">"V"</span>, <span class="string">"_ivar1"</span>&#125;;</span><br><span class="line">objc_property_attribute_t attrs[] = &#123;type, ownership, backingivar&#125;;</span><br><span class="line"></span><br><span class="line">class_addProperty<span class="params">(cls, <span class="string">"property2"</span>, attrs, <span class="number">3</span>)</span>;</span><br><span class="line">objc_registerClassPair<span class="params">(cls)</span>;</span><br><span class="line"></span><br><span class="line">id instance = [[cls alloc] init];</span><br><span class="line">[instance performSelector:@selector<span class="params">(submethod1)</span>];</span><br><span class="line">[instance performSelector:@selector<span class="params">(method1)</span>];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>程序的输出如下：<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2014</span>-<span class="number">10</span>-<span class="number">23</span> <span class="number">11</span>:<span class="number">35</span>:<span class="number">31.006</span> RuntimeTest[<span class="number">3800</span>:<span class="number">66152</span>] run sub <span class="function"><span class="keyword">method</span> 1</span><br><span class="line">2014-10-23 11:</span><span class="number">35</span>:<span class="number">31.006</span> RuntimeTest[<span class="number">3800</span>:<span class="number">66152</span>] run sub <span class="function"><span class="keyword">method</span> 1</span></span><br></pre></td></tr></table></figure></p>
<h5 id="动态创建对象">动态创建对象</h5><p>动态创建对象的函数如下：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建类实例</span></span><br><span class="line"><span class="keyword">id</span> class_createInstance ( Class cls, size_t extraBytes );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在指定位置创建类实例</span></span><br><span class="line"><span class="keyword">id</span> objc_constructInstance ( Class cls, <span class="keyword">void</span> *bytes );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁类实例</span></span><br><span class="line"><span class="keyword">void</span> * objc_destructInstance ( <span class="keyword">id</span> obj );</span><br></pre></td></tr></table></figure></p>
<p>class_createInstance函数：创建实例时，会在默认的内存区域为类分配内存。extraBytes参数表示分配的额外字节数。这些额外的字节可用于存储在类定义中所定义的实例变量之外的实例变量。该函数在ARC环境下无法使用。<br>调用class_createInstance的效果与+alloc方法类似。不过在使用class_createInstance时，我们需要确切的知道我们要用它来做什么。在下面的例子中，我们用NSString来测试一下该函数的实际效果：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> theObject = class_createInstance(<span class="built_in">NSString</span><span class="variable">.class</span>, <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span>));</span><br><span class="line"><span class="keyword">id</span> str1 = [theObject init];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [str1 class]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span> str2 = [[<span class="built_in">NSString</span> alloc] initWithString:<span class="string">@"test"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [str2 class]);</span><br></pre></td></tr></table></figure></p>
<p>输出结果是：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2014<span class="tag">-10-23</span> 12<span class="pseudo">:46</span><span class="pseudo">:50</span><span class="class">.781</span> <span class="tag">RuntimeTest</span><span class="attr_selector">[4039:89088]</span> <span class="tag">NSString</span></span><br><span class="line">2014<span class="tag">-10-23</span> 12<span class="pseudo">:46</span><span class="pseudo">:50</span><span class="class">.781</span> <span class="tag">RuntimeTest</span><span class="attr_selector">[4039:89088]</span> __<span class="tag">NSCFConstantString</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，使用class_createInstance函数获取的是NSString实例，而不是类簇中的默认占位符类_NSCFConstantString</p>
<ul>
<li>objc_constructInstance函数：在指定的位置(bytes)创建类实例。</li>
<li>objc_destructInstance函数：销毁一个类的实例，但不会释放并移除任何与其相关的引用。</li>
</ul>
<h4 id="实例操作函数">实例操作函数</h4><p>实例操作函数主要是针对我们创建的实例对象的一系列操作函数，我们可以使用这组函数来从实例对象中获取我们想要的一些信息，如实例对象中变量的值。这组函数可以分为三小类：</p>
<ol>
<li>针对整个对象进行操作的函数，这类函数包含<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回指定对象的一份拷贝</span></span><br><span class="line"><span class="keyword">id</span> object_copy ( <span class="keyword">id</span> obj, size_t size );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放指定对象占用的内存</span></span><br><span class="line"><span class="keyword">id</span> object_dispose ( <span class="keyword">id</span> obj );</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>有这样一种场景，假设我们有类A和类B，且类B是类A的子类。类B通过添加一些额外的属性来扩展类A。现在我们创建了一个A类的实例对象，并希望在运行时将这个对象转换为B类的实例对象，这样可以添加数据到B类的属性中。这种情况下，我们没有办法直接转换，因为B类的实例会比A类的实例更大，没有足够的空间来放置对象。此时，我们就要以使用以上几个函数来处理这种情况，如下代码所示：<br><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSObject *a = [[NSObject alloc] init];</span><br><span class="line">id newB = <span class="keyword">object</span><span class="number">_</span>copy(a, <span class="keyword">class</span><span class="number">_</span>getInstanceSize(MyClass.<span class="keyword">class</span>));</span><br><span class="line"><span class="keyword">object</span><span class="number">_</span>setClass(newB, MyClass.<span class="keyword">class</span>);</span><br><span class="line"><span class="keyword">object</span><span class="number">_</span>dispose(a);</span><br></pre></td></tr></table></figure></p>
<ol>
<li>针对对象实例变量进行操作的函数，这类函数包含：<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改类实例的实例变量的值</span></span><br><span class="line">Ivar object_setInstanceVariable ( <span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> *value );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对象实例变量的值</span></span><br><span class="line">Ivar object_getInstanceVariable ( <span class="keyword">id</span> obj, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> **outValue );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指向给定对象分配的任何额外字节的指针</span></span><br><span class="line"><span class="keyword">void</span> * object_getIndexedIvars ( <span class="keyword">id</span> obj );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回对象中实例变量的值</span></span><br><span class="line"><span class="keyword">id</span> object_getIvar ( <span class="keyword">id</span> obj, Ivar ivar );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置对象中实例变量的值</span></span><br><span class="line"><span class="keyword">void</span> object_setIvar ( <span class="keyword">id</span> obj, Ivar ivar, <span class="keyword">id</span> value );</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果实例变量的Ivar已经知道，那么调用object_getIvar会比object_getInstanceVariable函数快，相同情况下，object_setIvar也比object_setInstanceVariable快。</p>
<ol>
<li>针对对象的类进行操作的函数，这类函数包含：<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回给定对象的类名</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> * object_getClassName ( <span class="keyword">id</span> obj );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回对象的类</span></span><br><span class="line">Class object_getClass ( <span class="keyword">id</span> obj );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置对象的类</span></span><br><span class="line">Class object_setClass ( <span class="keyword">id</span> obj, Class cls );</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="获取类定义">获取类定义</h4><p>Objective-C动态运行库会自动注册我们代码中定义的所有的类。我们也可以在运行时创建类定义并使用objc_addClass函数来注册它们。runtime提供了一系列函数来获取类定义相关的信息，这些函数主要包括：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取已注册的类定义的列表</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">objc_getClassList</span> <span class="params">( Class *buffer, <span class="keyword">int</span> bufferCount )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建并返回一个指向所有已注册类的指针列表</span></span><br><span class="line">Class * objc_copyClassList ( <span class="keyword">unsigned</span> <span class="keyword">int</span> *outCount );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指定类的类定义</span></span><br><span class="line"><span class="function">Class <span class="title">objc_lookUpClass</span> <span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"><span class="function">Class <span class="title">objc_getClass</span> <span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"><span class="function">Class <span class="title">objc_getRequiredClass</span> <span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回指定类的元类</span></span><br><span class="line"><span class="function">Class <span class="title">objc_getMetaClass</span> <span class="params">( <span class="keyword">const</span> <span class="keyword">char</span> *name )</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>objc_getClassList函数：获取已注册的类定义的列表。我们不能假设从该函数中获取的类对象是继承自NSObject体系的，所以在这些类上调用方法是，都应该先检测一下这个方法是否在这个类中实现<br><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">int numClasses;</span><br><span class="line">Class <span class="built_in">*</span> classes = NULL;</span><br><span class="line"></span><br><span class="line">numClasses = objc_getClassList<span class="params">(NULL, <span class="number">0</span>)</span>;</span><br><span class="line"><span class="keyword">if</span> <span class="params">(numClasses &gt; <span class="number">0</span>)</span> &#123;</span><br><span class="line">    classes = malloc<span class="params">(sizeof<span class="params">(Class)</span> * numClasses)</span>;</span><br><span class="line">    numClasses = objc_getClassList<span class="params">(classes, numClasses)</span>;</span><br><span class="line"></span><br><span class="line">    NSLog<span class="params">(@<span class="string">"number of classes: %d"</span>, numClasses)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; numClasses; i++)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Class cls = classes[i];</span><br><span class="line">        NSLog<span class="params">(@<span class="string">"class name: %s"</span>, class_getName<span class="params">(cls)</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    free<span class="params">(classes)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果如下：<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.58</span>9 RuntimeTest[<span class="number">8437:188589</span>] number of classes: 1282</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.58</span>9 RuntimeTest[<span class="number">8437:188589</span>] class name: DDTokenRegexp</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>0 RuntimeTest[<span class="number">8437:188589</span>] class name: _NSMostCommonKoreanCharsKeySet</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>0 RuntimeTest[<span class="number">8437:188589</span>] class name: OS_xpc_dictionary</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>0 RuntimeTest[<span class="number">8437:188589</span>] class name: NSFileCoordinator</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>0 RuntimeTest[<span class="number">8437:188589</span>] class name: NSAssertionHandler</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>0 RuntimeTest[<span class="number">8437:188589</span>] class name: PFUbiquityTransactionLogMigrator</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>1 RuntimeTest[<span class="number">8437:188589</span>] class name: NSNotification</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>1 RuntimeTest[<span class="number">8437:188589</span>] class name: NSKeyValueNilSetEnumerator</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>1 RuntimeTest[<span class="number">8437:188589</span>] class name: OS_tcp_connection_tls_session</span><br><span class="line"><span class="number">2014-10-23</span> <span class="number">16:20:52.59</span>1 RuntimeTest[<span class="number">8437:188589</span>] class name: _PFRoutines</span><br><span class="line">......还有大量输出</span><br></pre></td></tr></table></figure></p>
<ul>
<li>获取类定义的方法有三个：objc_lookUpClass, objc_getClass和objc_getRequiredClass。如果类在运行时未注册，则objc_lookUpClass会返回nil，而objc_getClass会调用类处理回调，并再次确认类是否注册，如果确认未注册，再返回nil。而objc_getRequiredClass函数的操作与objc_getClass相同，只不过如果没有找到类，则会杀死进程。</li>
<li>objc_getMetaClass函数：如果指定的类没有注册，则该函数会调用类处理回调，并再次确认类是否注册，如果确认未注册，再返回nil。不过，每个类定义都必须有一个有效的元类定义，所以这个函数总是会返回一个元类定义，不管它是否有效。</li>
</ul>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/IOS/"> #IOS </a>
          
            <a href="/tags/runtime/"> #runtime </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/07/13/iOS-Category/">iOS Category</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/07/13/iOS-Event-Delivery-The-Responder-Chain/">iOS Event Delivery/ The Responder Chain</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/avatar.png" alt="Yt" />
          <p class="site-author-name">Yt</p>
        </div>
        <p class="site-description motion-element">notes for study</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">218</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">28</span>
              <span class="site-state-item-name">分類</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">102</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </div>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml">
              <i class="menu-item-icon icon-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/ytlvy" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/ytlvy" target="_blank">Twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://nshipster.com" target="_blank">NSHipster</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.mikeash.com/pyblog" target="_blank">NSBlog</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.objc.io" target="_blank">objcio</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.raywenderlich.com" target="_blank">raywenderlich</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#iOS_Runtime运行时类与对象的编译处理"><span class="nav-number">1.</span> <span class="nav-text">iOS Runtime运行时类与对象的编译处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类与对象基础数据结构"><span class="nav-number">1.1.</span> <span class="nav-text">类与对象基础数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Class"><span class="nav-number">1.1.1.</span> <span class="nav-text">Class</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#objc_object与id"><span class="nav-number">1.1.2.</span> <span class="nav-text">objc_object与id</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#objc_cache"><span class="nav-number">1.1.3.</span> <span class="nav-text">objc_cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#元类(Meta_Class)"><span class="nav-number">1.1.4.</span> <span class="nav-text">元类(Meta Class)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类与对象操作函数"><span class="nav-number">1.1.5.</span> <span class="nav-text">类与对象操作函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类相关操作函数"><span class="nav-number">1.1.6.</span> <span class="nav-text">类相关操作函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#类名(name)"><span class="nav-number">1.1.7.</span> <span class="nav-text">类名(name)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#父类(super_class)和元类(meta-class)"><span class="nav-number">1.1.8.</span> <span class="nav-text">父类(super_class)和元类(meta-class)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例变量大小(instance_size)"><span class="nav-number">1.1.9.</span> <span class="nav-text">实例变量大小(instance_size)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#成员变量(ivars)及属性"><span class="nav-number">1.1.10.</span> <span class="nav-text">成员变量(ivars)及属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方法(methodLists)"><span class="nav-number">1.1.11.</span> <span class="nav-text">方法(methodLists)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#协议(objc_protocol_list)"><span class="nav-number">1.1.12.</span> <span class="nav-text">协议(objc_protocol_list)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#版本(version)"><span class="nav-number">1.1.13.</span> <span class="nav-text">版本(version)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其它"><span class="nav-number">1.1.14.</span> <span class="nav-text">其它</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例(Example)"><span class="nav-number">1.1.15.</span> <span class="nav-text">实例(Example)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态创建类和对象"><span class="nav-number">1.1.16.</span> <span class="nav-text">动态创建类和对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#动态创建类"><span class="nav-number">1.1.16.1.</span> <span class="nav-text">动态创建类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#动态创建对象"><span class="nav-number">1.1.16.2.</span> <span class="nav-text">动态创建对象</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例操作函数"><span class="nav-number">1.1.17.</span> <span class="nav-text">实例操作函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取类定义"><span class="nav-number">1.1.18.</span> <span class="nav-text">获取类定义</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Yt</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="theme-info">
  <span id="busuanzi_container_site_uv">
    &nbsp&nbsp&nbsp&nbsp|&nbsp&nbsp Total <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> views.
您是本站的第<span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span>个小伙伴
<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Hits
  </span>
<div>
      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js"></script>


  <script type="text/javascript" src="/js/helpers.js"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js" id="motion.global"></script>




  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  
  

  

    
      
    

    <script type="text/javascript">
      var disqus_shortname = 'ytlvy';
      var disqus_identifier = '2015/07/13/iOS-Runtime-运行时类与对象的编译处理/';
      var disqus_title = 'iOS Runtime 运行时类与对象的编译处理';
      var disqus_url = 'http://ytlvy.com/2015/07/13/iOS-Runtime-运行时类与对象的编译处理/';

      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  




  
  

</body>
</html>
