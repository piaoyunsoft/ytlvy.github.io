<!doctype html>
<html class="theme-next use-motion ">
<head>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">


<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="notes for study" />



  <meta name="keywords" content="BLock,GCD," />



  <link rel="alternate" href="/atom.xml" title="Yt's Blog" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    analytics: {
      google: ''
    },
    sidebar: 'post'
  };
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b8a916e09c6b39221eb089c8ad75ede9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <title> IOS Multithreading && Memory Management // Yt's Blog </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Yt's Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
     
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          首頁
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          分類
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about">
          <i class="menu-item-icon icon-about"></i> <br />
          關於
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          歸檔
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          標籤
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              IOS Multithreading && Memory Management
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-06-07
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分類於
            
              <a href="/categories/IOS/">IOS</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/06/07/IOS-Multithreading-Memory-Management/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/06/07/IOS-Multithreading-Memory-Management/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <h2 id="Block">Block</h2><p>Converting Source Code<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -rewrite-objc file_name_of_the_<span class="built_in">source</span>_code</span><br></pre></td></tr></table></figure></p>
<h3 id="无变量">无变量</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Block\n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA);</span><br><span class="line"></span><br><span class="line">  ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="static变量">static变量</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">    <span class="keyword">struct</span> __block_impl <span class="keyword">impl</span>;</span><br><span class="line">    <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *static_val;</span><br><span class="line"></span><br><span class="line">    __main_block_impl_0(void *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc,</span><br><span class="line">    <span class="keyword">int</span> *_static_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : static_val(_static_val) &#123;</span><br><span class="line">        <span class="keyword">impl</span>.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">        <span class="keyword">impl</span>.Flags = flags;</span><br><span class="line">        <span class="keyword">impl</span>.FuncPtr = fp;</span><br><span class="line">        Desc = desc; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> void __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    <span class="keyword">int</span> *static_val = __cself-&gt;static_val;</span><br><span class="line">    (*static_val) *= <span class="number">3</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="__block_variable">__block variable</h3><p>将原来的变量更改为：Block_byref_val变量，此变量包含一个forwarding影像，用来存放block对其的修改。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__block variable</span></span><br><span class="line"><span class="keyword">struct</span> __block_impl &#123;</span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags;</span><br><span class="line">  <span class="keyword">int</span> Reserved;</span><br><span class="line">  <span class="keyword">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __Block_byref_val_0 &#123;</span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_val_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line"></span><br><span class="line">  __Block_byref_val_0 *val; <span class="comment">// by ref</span></span><br><span class="line"></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, __Block_byref_val_0 *_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref</span></span><br><span class="line">(val-&gt;__forwarding-&gt;val) = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;val, (<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_0 &#123;</span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*copy)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> __main_block_impl_1 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_1* Desc;</span><br><span class="line"></span><br><span class="line">  __Block_byref_val_0 *val; <span class="comment">// by ref</span></span><br><span class="line"></span><br><span class="line">  __main_block_impl_1(<span class="keyword">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_1 *desc, __Block_byref_val_0 *_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_1(<span class="keyword">struct</span> __main_block_impl_1 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref</span></span><br><span class="line">(val-&gt;__forwarding-&gt;val) = <span class="number">2</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_1(<span class="keyword">struct</span> __main_block_impl_1*dst, <span class="keyword">struct</span> __main_block_impl_1*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;val, (<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_1(<span class="keyword">struct</span> __main_block_impl_1*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> __main_block_desc_1 &#123;</span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*copy)(<span class="keyword">struct</span> __main_block_impl_1*, <span class="keyword">struct</span> __main_block_impl_1*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_1*);</span><br><span class="line">&#125; __main_block_desc_1_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_1), __main_block_copy_1, __main_block_dispose_1&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  __attribute__((__blocks__(byref))) __Block_byref_val_0 val = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_val_0), <span class="number">10</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, <span class="number">570425344</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">void</span> (*blk1)(<span class="keyword">void</span>) = (<span class="keyword">void</span> (*)())&amp;__main_block_impl_1((<span class="keyword">void</span> *)__main_block_func_1, &amp;__main_block_desc_1_DATA, (__Block_byref_val_0 *)&amp;val, <span class="number">570425344</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> IMAGE_INFO &#123; <span class="keyword">unsigned</span> version; <span class="keyword">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>two block share same instance of the __Block_byref_val_0</p>
<h3 id="Memory_Segments_for_Blocks">Memory Segments for Blocks</h3><ol>
<li>_NSConcreteStackBlock</li>
<li>_NSConcreteGlobalBlock</li>
<li>_NSConcreteMallocBlock</li>
</ol>
<p>|  program area   |<br>| (.text section) |<br>|————————-|<br>|   data area     |<br>|   .data section |  &lt;——-  _NSConcreteGlobalBlock<br>|————————-|<br>|                 |<br>|       heap      |  &lt;——-  _NSConcreteMallocBlock<br>|                 |<br>|                 |<br>|————————-|<br>|      stack      |  &lt;——-  _NSConcreteStackBlock</p>
<h4 id="NSConcreteGlobalBlock_Class_Object">NSConcreteGlobalBlock Class Object</h4><ol>
<li>when a Block literal is written where a global variable is<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (^blk)(<span class="keyword">void</span>) = ^&#123;<span class="built_in">printf</span>(<span class="string">"Global Block\n"</span>);&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Because automatic variables can’t exist where the global variables are declared, capturing never happens</p>
<ol>
<li>when a Block literal is inside a function and doesn’t capture any automatic variables</li>
</ol>
<blockquote>
<p>Any Block created by another kind of Block literal will be an object of the _NSConcreteStackBlock class, and be stored on the stack.<br>此外所有其他生成的block都是_NSConcreteStackBlock</p>
<p>A Block, which is stored in the data section like global variables, can be accessed safely via pointers outside any variable scopes. But the other Blocks, which are stored on the stack, will be disposed of after the scope of the Block is left. And <strong>block variables are stored on the stack as well, so the </strong>block variables will be disposed of when the scope is left<br>全局block， 可以在任何函数域内，安全的进行存取。但是stackBlock会在函数域结束后，被自动释放。为了解决这个问题，Block提供了一种机制，可以将StackBlock复制到heap</p>
</blockquote>
<h4 id="Block_on_the_Heap">Block on the Heap</h4><p>复制到堆上的闭包类型, 变更为NSConcreteMallocBlock. __forwarding变量用来指向闭包,具体的存放位置, stack or heap.</p>
<h4 id="Copying_Blocks_Automatically">Copying Blocks Automatically</h4><p>在ARC环境下, 系统会自动检测, 并将block复制到heap.<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="keyword">int</span> (^blk_t)(<span class="keyword">int</span>);</span><br><span class="line">blk_t func(<span class="keyword">int</span> rate)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ^(<span class="keyword">int</span> <span class="keyword">count</span>)&#123;<span class="keyword">return</span> rate * <span class="keyword">count</span>;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Coping_Blocks_Manually">Coping Blocks Manually</h4><p>系统不能自动检测的情况</p>
<ol>
<li>When a Block is passed as an argument for methods or functions<br>(But if the method or the function copies the argument inside, the caller doesn’t need to copy it manually as)</li>
<li>Cocoa Framework methods, the name of which includes “usingBlock”</li>
<li>GCD API</li>
</ol>
<p>you need to copy a Block when you pass it to an NSArray class instance method “initWithObjects”<br>当你将Block作为参数, 传入数组 ‘initWithObjects’时,需要手动复制<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>) getBlockArray</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">NSArray</span> alloc] initWithObjects: </span><br><span class="line">     [^&#123;<span class="built_in">NSLog</span>(<span class="string">@"blk0:%d"</span>, val);&#125; <span class="keyword">copy</span>],</span><br><span class="line">     [^&#123;<span class="built_in">NSLog</span>(<span class="string">@"blk1:%d"</span>, val);&#125; <span class="keyword">copy</span>],</span><br><span class="line">      <span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>尽量多得使用copy对Block无不良影响</p>
<h4 id="Memory_Segments_for___block_Variables">Memory Segments for __block Variables</h4><ol>
<li>当闭包被复制到Heap时, 如果闭包使用了__block变量, 且此变量未被其他block使用, 此变量也会被复制到heap.</li>
<li>如果__block变量被多个闭包使用, 此变量也会被复制到heap. 当二个闭包被复制时, heap中得变量引用指数+1.</li>
</ol>
<h4 id="__forwarding">__forwarding</h4><p>始终指向最新的Block, 可以对齐进行存取</p>
<h4 id="automatic_variables_of_C_array_type_can’t_be_used_in_a_Block_directly">automatic variables of C array type can’t be used in a Block directly</h4><p>原因是C语言不允许将一个数组变量，赋值另外一个数组变量, 不能编译<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">char</span> a[10])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> b[<span class="number">10</span>] = a;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, b[<span class="number">0</span>]); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> a[<span class="number">10</span>] = &#123;<span class="number">2</span>&#125;;</span><br><span class="line">    func(a); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Capturing_Objects">Capturing Objects</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __main_block_impl_0 &#123;</span><br><span class="line">  <span class="keyword">struct</span> __block_impl impl;</span><br><span class="line">  <span class="keyword">struct</span> __main_block_desc_0* Desc;</span><br><span class="line">  <span class="keyword">id</span> __<span class="keyword">strong</span> array;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="When_is_the_Block_on_the_stack_copied_to_the_heap">When is the Block on the stack copied to the heap</h4><p>􏰀1. When the instance method “copy” is called on the Block<br>􏰀2. When the Block is returned from a function<br>􏰀3. When the Block is assigned to a member variable of id or the Block type class, with __strong qualifier<br>􏰀4. When the Block is passed to a method, including “usingBlock” in the Cocoa Framework, or a Grand Central Dispatch API</p>
<h4 id="When_You_Should_Call_the_“copy”_Method">When You Should Call the “copy” Method</h4><p>􏰀1. When the Block is returned from a function<br>􏰀2. When the Block is assigned to a member variable of id or the Block<br>type class, with a __strong qualifier<br>􏰀3. When the Block is passed to a method, including “usingBlock” in the Cocoa Framework, or a Grand Central Dispatch API</p>
<h4 id="Circular_Reference_with_Blocks">Circular Reference with Blocks</h4><p>__weak</p>
<p>在不支持weak的情况下<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">id</span> tmp = <span class="keyword">self</span>;</span><br><span class="line">blk_ = ^&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"self = %@"</span>, tmp);</span><br><span class="line">  tmp = <span class="literal">nil</span>; </span><br><span class="line">&#125;;</span><br><span class="line">- (<span class="keyword">void</span>)execBlock &#123;</span><br><span class="line">  blk_();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果不执行execBlock, 还是存在循环引用, 要确保执行了execBlock</p>
<h2 id="GCD">GCD</h2><h3 id="befor_GCD">befor GCD</h3><h4 id="object_method">object method</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="typename">void</span>) <span class="string">performSelectorInBackground:</span> <span class="string">withObject:</span></span><br><span class="line">- (<span class="typename">void</span>) <span class="string">performSelectorOnMainThread:</span> <span class="string">withObject:</span> <span class="string">waitUntilDone:</span></span><br></pre></td></tr></table></figure>
<h3 id="多线程面临的问题">多线程面临的问题</h3><ol>
<li>race condition</li>
<li>dead lock</li>
<li>too much threads consumes two much memory</li>
</ol>
<h4 id="多线程的意义">多线程的意义</h4><p>高交互性， 界面编程中，将耗时的操作放入到其他线程执行，避免影响到主线程界面响应</p>
<h3 id="GCD_基础">GCD 基础</h3><h4 id="Dispatch_Queue_派发队列">Dispatch Queue 派发队列</h4><ol>
<li>serial dispath queue  顺序派发队列</li>
<li>concurrent dispath queue  并发派发队列</li>
</ol>
<p>和浏览器对同一域名可发起的同时连接数限制一样，可最多同时执行的线程数，也是由系统来决定的</p>
<h4 id="创建队列">创建队列</h4><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dispath_queue_t mySerialDispatchQueue = dispatch_queue_create<span class="list">(<span class="string">"com.example.gcd.MySerialDispatchQueue"</span>, NULL)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_queue_t myConcurrentDispathQueue = dispatch_queue_create<span class="list">(<span class="string">"com.ytlvy.gcd.MyConcurrentDispatchQueue"</span>, DISPATCH_QUEUE_CONCURRENT)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">myConcurrentQueue</span>, ^&#123;</span><br><span class="line">  //do staff</span><br><span class="line">  &#125;)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_release<span class="list">(<span class="keyword">mySerialDispatchQueue</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_retain<span class="list">(<span class="keyword">myConcurrentDispatchQueue</span>)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>当并发队列添加任务后，队列被release，是没有问题的。因为block在添加到队列时，会触发dispatch_retain操作来持有队列，在block结束时，会自动触发dispatch_release来释放队列</p>
<h4 id="Main_Dispatch_Queue_/_Global_Dispatch_Queue">Main Dispatch Queue / Global Dispatch Queue</h4><p>可以采用系统方法来获取派发队列。<br> NAME                              | Type        | Description<br> ————————————          | ——————| ————————<br> Main dispatch queue               | Serial      | Executed on the main thread<br> Global dispatch queue(Hight)      | Concurrent  | Priority High<br> Global dispatch queue(default)    | Concurrent  | Priority Normal<br> Global dispatch queue(low)        | Concurrent  | Priority Low<br> Global dispatch queue(background) | Concurrent  | Priority Background</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t mainDispatchQueue = dispatch_get_main_queue<span class="list">()</span><span class="comment">;</span></span><br><span class="line">dispatch_queue_t globalDispatchQueueHight = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_HIGH</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_queue_t globalDispatchQueueDefault =</span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_queue_t globalDispatchQueueLow = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_LOW</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_queue_t globalDispatchQueueBackground = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_BACKGROUND</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>dispatch_retain dispatch_release对系统分配的队列不生效。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">dispatch_async</span>(<span class="function">dispatch_get_global_queue</span>(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>) ^&#123;</span><br><span class="line">   <span class="comment">//do staff</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">dispatch_async</span>(dispatch_get_main_queue, ^&#123;</span><br><span class="line">    <span class="comment">// update gui</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="Controlling_Dispatch_Queue">Controlling Dispatch Queue</h4><p><code>dispatch_set_target_queue</code>设置队列优先级</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t mySerialDispatchQueue = </span><br><span class="line">    dispatch_create<span class="list">(<span class="string">"com.ytlvy.gcd.MySerialDispatchQueue"</span>, NULL)</span><span class="comment">;</span></span><br><span class="line">dispatch_queue_t globalDispatchQueueBackGround = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_BACKGROUND</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_set_target_queue<span class="list">(<span class="keyword">mySerialDispatchQueue</span>, globalDispatchQueueBackground)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h4 id="dispatch_after">dispatch_after</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_time_t</span> time = <span class="keyword">dispatch_t</span>ime(DISPATCH_TIME_NOW, <span class="number">3u</span>ll * NSEC_PER_SEC);</span><br><span class="line"></span><br><span class="line">dispatch_after(time, dispatch_get_main_queue(), ^&#123;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>“ull” is for “unsigned long long type”</p>
<p>毫秒<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_time_t</span> time = <span class="keyword">dispatch_t</span>ime(DISPATCH_TIME_NOW, <span class="number">1u</span>ll * NSEC_PER_MSEC);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dispatch_time_t getDispatchTimeByDate(NSDate *<span class="type">date</span>)&#123;</span><br><span class="line">  NSTimeInterval interval;</span><br><span class="line">  double <span class="keyword">second</span>, subsecond;</span><br><span class="line">  struct timespec, <span class="property">time</span>;</span><br><span class="line">  dispatch_time_t milestone;</span><br><span class="line"></span><br><span class="line">  interval = [<span class="type">date</span> timeIntervalSince1970];</span><br><span class="line">  subsecond = modf(interval, &amp;<span class="keyword">second</span>);</span><br><span class="line">  <span class="property">time</span>.tv_sec = <span class="keyword">second</span>;</span><br><span class="line">  <span class="property">time</span>.tv_nsec = subsecond * NSEC_PER_SEC;</span><br><span class="line">  milestone = dispatch_wailltime(&amp;<span class="property">time</span>, <span class="number">0</span>);</span><br><span class="line"><span class="command"></span><br><span class="line">  return</span> milstone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，dispatch第二个参数，应该使用<code>ull</code> 或者 <code>double</code>类型<br><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SDate <span class="built_in">*</span>start = [NSDate date];</span><br><span class="line">dispatch_time_t popTime = dispatch_time<span class="params">(DISPATCH_TIME_NOW, <span class="number">4</span> * NSEC_PER_SEC)</span>;</span><br><span class="line"></span><br><span class="line">dispatch_after<span class="params">(popTime, dispatch_get_main_queue<span class="params">()</span>, ^&#123;</span><br><span class="line">  NSLog<span class="params">(@<span class="string">"seconds: %f"</span>, [start timeIntervalSinceNow])</span>;</span><br><span class="line">&#125;)</span>;</span><br><span class="line"><span class="comment">// output: seconds: -0.0001</span></span><br><span class="line"></span><br><span class="line">NSDate <span class="built_in">*</span>start = [NSDate date];</span><br><span class="line">dispatch_time_t popTime = dispatch_time<span class="params">(DISPATCH_TIME_NOW, <span class="number">4.0</span> * NSEC_PER_SEC)</span>;</span><br><span class="line"></span><br><span class="line">dispatch_after<span class="params">(popTime, dispatch_get_main_queue<span class="params">()</span>, ^&#123;</span><br><span class="line">  NSLog<span class="params">(@<span class="string">"seconds: %f"</span>, [start timeIntervalSinceNow])</span>;</span><br><span class="line">&#125;)</span>;</span><br><span class="line"><span class="comment">// output: seconds: -4.0001</span></span><br></pre></td></tr></table></figure></p>
<h4 id="dispatch_group">dispatch group</h4><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_group_t group = dispatch_group_create<span class="list">()</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_group_async<span class="list">(<span class="keyword">group</span>, queue, ^&#123; NSLog<span class="list">(@<span class="string">"blk0"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line">dispatch_group_async<span class="list">(<span class="keyword">group</span>, queue, ^&#123; NSLog<span class="list">(@<span class="string">"blk1"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line">dispatch_group_async<span class="list">(<span class="keyword">group</span>, queue, ^&#123; NSLog<span class="list">(@<span class="string">"blk2"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line"></span><br><span class="line">dispatch_group_notify<span class="list">(<span class="keyword">group</span>, dispatch_get_main_queue<span class="list">()</span>, ^&#123; NSLog<span class="list">(@<span class="string">"done"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line">dispatch_release<span class="list">(<span class="keyword">group</span>)</span><span class="comment">;</span></span></span></span></span></span><br></pre></td></tr></table></figure>
<p>等所有任务结束，使用派发队列组。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_group_t group = dispatch_group_create<span class="list">()</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_group_async<span class="list">(<span class="keyword">group</span>, queue, ^&#123;NSLog<span class="list">(@<span class="string">"blk0"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line">dispatch_group_async<span class="list">(<span class="keyword">group</span>, queue, ^&#123;NSLog<span class="list">(@<span class="string">"blk1"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line">dispatch_group_async<span class="list">(<span class="keyword">group</span>, queue, ^&#123;NSLog<span class="list">(@<span class="string">"blk2"</span>)</span><span class="comment">; &#125;);</span></span><br><span class="line"></span><br><span class="line">dispatch_group_wait<span class="list">(<span class="keyword">group</span>, DISPATCH_TIME_FOREVER)</span><span class="comment">;</span></span><br><span class="line">dispatch_release<span class="list">(<span class="keyword">group</span>)</span><span class="comment">;</span></span></span></span></span><br></pre></td></tr></table></figure></p>
<p>等待1秒<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dispatch_time_t time = dispatch_time(<span class="type">DISPATCH_TIME_NOW</span>, <span class="number">1</span>ull * <span class="type">NSEC_PER_SEC</span>);</span><br><span class="line">long <span class="literal">result</span> = dispatch_group_wait(group, time);</span><br><span class="line"><span class="keyword">if</span>(<span class="literal">result</span> == <span class="number">0</span>)&#123;</span><br><span class="line">  //finished</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  //some task still running</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>检测任务是否完成<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long <span class="literal">result</span> = dispatch_group_wait(group, <span class="type">DISPATCH_TIME_NOW</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="dispatch_barrier_async">dispatch_barrier_async</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = dispatch_queue_create<span class="list">(</span><br><span class="line">      <span class="string">"com.example.gcd.ForBarrier"</span>, DISPATCH_QUEUE_CONCURRENT)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, blk0_for_reading)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, blk1_for_reading)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, blk2_for_reading)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, blk3_for_reading)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_barrier_async<span class="list">(<span class="keyword">queue</span>, blk_for_writing)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, blk4_for_reading)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, blk5_for_reading)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_release<span class="list">(<span class="keyword">queue</span>)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h3 id="dispatch_sync">dispatch_sync</h3><p>dead lock<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = dispatch_get_main_queue<span class="list">()</span><span class="comment">;</span></span><br><span class="line">dispatch_sync<span class="list">(<span class="keyword">queue</span>, ^&#123;&#125;)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">//dead lock</span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, ^&#123;</span><br><span class="line">  dispatch_sync<span class="list">(<span class="keyword">queue</span>, ^&#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><span class="comment">;</span></span><br><span class="line">  &#125;)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">//serial queue  dead lock</span><br><span class="line">dispatch_queue_t queue = dispatch_queue_create<span class="list">(<span class="string">"com.example"</span>, NULL)</span><span class="comment">;</span></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, ^&#123;</span><br><span class="line">  dispatch_sync<span class="list">(<span class="keyword">queue</span>, ^&#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><span class="comment">;</span></span><br><span class="line">  &#125;)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="dispatch_apply">dispatch_apply</h4><p>与 <code>dispatch_sync</code> 和<code>dispatch_group</code>相关，可以多次添加同一任务, 并等待任务结束</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue =</span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_apply<span class="list">(<span class="number">10</span>, queue, ^<span class="list">(<span class="keyword">size_t</span> index)</span>&#123;</span><br><span class="line">  NSLog<span class="list">(<span class="string">"%zu"</span>, index)</span><span class="comment">;</span></span><br><span class="line">  &#125;)</span><span class="comment">;</span></span><br><span class="line">NSLog<span class="list">(@<span class="string">"done"</span>)</span><span class="comment">; //last output</span></span><br></pre></td></tr></table></figure>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue = </span><br><span class="line">    dispatch_get_global_queue<span class="list">(<span class="keyword">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_async<span class="list">(<span class="keyword">queue</span>, ^&#123;</span><br><span class="line"></span><br><span class="line">  dispatch_apply<span class="list">([array count], queue, ^<span class="list">(<span class="keyword">size_t</span> idx)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  //all tasks by dispatch_apply are finished</span><br><span class="line"></span><br><span class="line">  dispatch_async<span class="list">(<span class="keyword">dispatch_get_main_queue</span><span class="list">()</span>, ^&#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">  &#125;)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h4 id="dispatch_suspend_&amp;&amp;_dispatch_resume">dispatch_suspend &amp;&amp; dispatch_resume</h4><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dispatch_suspend<span class="list">(<span class="keyword">queue</span>)</span><span class="comment">;</span></span><br><span class="line">dispatch_resume<span class="list">(<span class="keyword">queue</span>)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h4 id="dispatch_semaphore">dispatch semaphore</h4><p>NSMutableArray 是非线程安全的，当多个线程同时更改操作会导致程序崩溃.semaphore是一个更小粒度的多线程控制方法, 通过内部计数来控制线程的准入方式.<br>semaphore拥有一个内部计数器来模拟标志, 当计数器为0, 线程等待; 非0时,继续执行.<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create<span class="list">(<span class="number">1</span>)</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">dispatch_remaphore_wait<span class="list">(<span class="keyword">semaphore</span>, DISPATCH_TIME_FOREVER)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dispatch_time_t time = dispatch_time(<span class="type">DISPATCH_TIME_NOW</span>, <span class="number">1</span>ull * <span class="type">NSEC_PER_SEC</span>);</span><br><span class="line">long <span class="literal">result</span> = dispatch_semaphore_wait(semaphore, time);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">result</span> == <span class="number">0</span>)&#123;</span><br><span class="line">  //<span class="keyword">do</span> staff, execute a task</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  //wait </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当dispatch_semaphore_wait 返回0时, 可以安全执行一个有并发控制的任务. 当任务执行完毕, 需要调用dispatch_semaphore_signal 增加计数</p>
<p>Adding data to NSMutableArray<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> <span class="built_in">queue</span> = </span><br><span class="line">    dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">dispatch_semaphore_t</span> semaphore = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">NSMutableArray *arr = [NSMutableArray <span class="keyword">new</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; <span class="number">100000</span>; i++)&#123;</span><br><span class="line">  dispatch_async(<span class="built_in">queue</span>, ^&#123;</span><br><span class="line">      dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span><br><span class="line">       *  因为semaphore的计数大于1. 在disaptch_semaphore_wait返回后,</span><br><span class="line">       *  计数器被设置为0. 因为只有一个线程可以获准进入,所以此时更新</span><br><span class="line">       *  NSMutableArray是安全的.</span><br><span class="line">       */</span></span><br><span class="line">      [arr addObject:@(i)];</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span><br><span class="line">       * 需要并发控制的任务结束后, 需要调用signal来增加semaphore的计数器,</span><br><span class="line">       * 以便其他等待的线程可以通过dispatch_semaphore_wait, 获得执行权限</span><br><span class="line">       */</span></span><br><span class="line">      dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatch_release(semaphore);</span><br></pre></td></tr></table></figure></p>
<h4 id="dispatch_once">dispatch_once</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> pred;</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;pred, ^&#123;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Dispatch_I/O">Dispatch I/O</h3><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t pipe_q =</span><br><span class="line">    dispatch_queue_create<span class="params">(<span class="string">"PipeQ"</span>, NULL)</span>;</span><br><span class="line">pipe_channel = dispatch_io_create<span class="params">(DISPATCH_IO_STREAM, fd, pipe_q, ^<span class="params">(int err)</span>&#123;</span><br><span class="line">  close<span class="params">(fd)</span>;</span><br><span class="line">  &#125;)</span>;</span><br><span class="line"></span><br><span class="line">  out_fd = fdpair[<span class="number">1</span>];</span><br><span class="line">  dispatch_io_set_low_water<span class="params">(pipe_channel, SIZE_MAX)</span>;</span><br><span class="line">  dispatch_io_read<span class="params">(pipe_channel, <span class="number">0</span>, SIZE_MAX, pipe_q, </span><br><span class="line">    ^<span class="params">(bool done, dispatch_data_t pipedata, int error)</span>&#123;</span><br><span class="line">      if<span class="params">(error == <span class="number">0</span>)</span>&#123;</span><br><span class="line">          size_t len = dispatch_data_get_size<span class="params">(pipedata)</span>;</span><br><span class="line">          if<span class="params">(len &gt; <span class="number">0</span>)</span>&#123;</span><br><span class="line">            const char *bytes = NULL;</span><br><span class="line">            char *encode;</span><br><span class="line"></span><br><span class="line">            dispatch_data_t md = dispatch_data_create_map<span class="params">(</span><br><span class="line">              pipedata, <span class="params">(const void **)</span>&amp;bytes, &amp;len)</span>;</span><br><span class="line">            encoded = asl_core_encode_buffer<span class="params">(bytes, len)</span>;</span><br><span class="line">            asl_set<span class="params">(<span class="params">(aslmsg)</span>merged_msg, ASL_KEY_AUX_DATA, encode)</span>;</span><br><span class="line">            free<span class="params">(encoded)</span>;</span><br><span class="line"></span><br><span class="line">            _asl_send_message<span class="params">(NULL, merged_msg, -<span class="number">1</span>, NULL)</span>;</span><br><span class="line">            asl_msg_release<span class="params">(merged_msg)</span>;</span><br><span class="line">            dispatch_release<span class="params">(md)</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if<span class="params">(done)</span>&#123;</span><br><span class="line">        dispatch_semaphore_signal<span class="params">(semaphore)</span>;</span><br><span class="line">        dispatch_relase<span class="params">(pipe_channel)</span>;</span><br><span class="line">        dispatch_release<span class="params">(pipe_q)</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;)</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/BLock/"> #BLock </a>
          
            <a href="/tags/GCD/"> #GCD </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/06/08/objc-runtime-method-Cache/">objc runtime method Cache</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/06/07/ice-girl/">冰之魔女</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/avatar.png" alt="Yt" />
          <p class="site-author-name">Yt</p>
        </div>
        <p class="site-description motion-element">notes for study</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">108</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">22</span>
              <span class="site-state-item-name">分類</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </div>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml">
              <i class="menu-item-icon icon-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/ytlvy" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/ytlvy" target="_blank">Twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://nshipster.com" target="_blank">NSHipster</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.mikeash.com/pyblog" target="_blank">NSBlog</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.objc.io" target="_blank">objcio</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.raywenderlich.com" target="_blank">raywenderlich</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Block"><span class="nav-number">1.</span> <span class="nav-text">Block</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#无变量"><span class="nav-number">1.1.</span> <span class="nav-text">无变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#static变量"><span class="nav-number">1.2.</span> <span class="nav-text">static变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#__block_variable"><span class="nav-number">1.3.</span> <span class="nav-text">__block variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory_Segments_for_Blocks"><span class="nav-number">1.4.</span> <span class="nav-text">Memory Segments for Blocks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSConcreteGlobalBlock_Class_Object"><span class="nav-number">1.4.1.</span> <span class="nav-text">NSConcreteGlobalBlock Class Object</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Block_on_the_Heap"><span class="nav-number">1.4.2.</span> <span class="nav-text">Block on the Heap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Copying_Blocks_Automatically"><span class="nav-number">1.4.3.</span> <span class="nav-text">Copying Blocks Automatically</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Coping_Blocks_Manually"><span class="nav-number">1.4.4.</span> <span class="nav-text">Coping Blocks Manually</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Memory_Segments_for___block_Variables"><span class="nav-number">1.4.5.</span> <span class="nav-text">Memory Segments for __block Variables</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#__forwarding"><span class="nav-number">1.4.6.</span> <span class="nav-text">__forwarding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#automatic_variables_of_C_array_type_can’t_be_used_in_a_Block_directly"><span class="nav-number">1.4.7.</span> <span class="nav-text">automatic variables of C array type can’t be used in a Block directly</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Capturing_Objects"><span class="nav-number">1.4.8.</span> <span class="nav-text">Capturing Objects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#When_is_the_Block_on_the_stack_copied_to_the_heap"><span class="nav-number">1.4.9.</span> <span class="nav-text">When is the Block on the stack copied to the heap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#When_You_Should_Call_the_“copy”_Method"><span class="nav-number">1.4.10.</span> <span class="nav-text">When You Should Call the “copy” Method</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Circular_Reference_with_Blocks"><span class="nav-number">1.4.11.</span> <span class="nav-text">Circular Reference with Blocks</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GCD"><span class="nav-number">2.</span> <span class="nav-text">GCD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#befor_GCD"><span class="nav-number">2.1.</span> <span class="nav-text">befor GCD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#object_method"><span class="nav-number">2.1.1.</span> <span class="nav-text">object method</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多线程面临的问题"><span class="nav-number">2.2.</span> <span class="nav-text">多线程面临的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#多线程的意义"><span class="nav-number">2.2.1.</span> <span class="nav-text">多线程的意义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GCD_基础"><span class="nav-number">2.3.</span> <span class="nav-text">GCD 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Dispatch_Queue_派发队列"><span class="nav-number">2.3.1.</span> <span class="nav-text">Dispatch Queue 派发队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建队列"><span class="nav-number">2.3.2.</span> <span class="nav-text">创建队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Main_Dispatch_Queue_/_Global_Dispatch_Queue"><span class="nav-number">2.3.3.</span> <span class="nav-text">Main Dispatch Queue / Global Dispatch Queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Controlling_Dispatch_Queue"><span class="nav-number">2.3.4.</span> <span class="nav-text">Controlling Dispatch Queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch_after"><span class="nav-number">2.3.5.</span> <span class="nav-text">dispatch_after</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch_group"><span class="nav-number">2.3.6.</span> <span class="nav-text">dispatch group</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch_barrier_async"><span class="nav-number">2.4.</span> <span class="nav-text">dispatch_barrier_async</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch_sync"><span class="nav-number">2.5.</span> <span class="nav-text">dispatch_sync</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch_apply"><span class="nav-number">2.5.1.</span> <span class="nav-text">dispatch_apply</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch_suspend_&&_dispatch_resume"><span class="nav-number">2.5.2.</span> <span class="nav-text">dispatch_suspend && dispatch_resume</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch_semaphore"><span class="nav-number">2.5.3.</span> <span class="nav-text">dispatch semaphore</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch_once"><span class="nav-number">2.5.4.</span> <span class="nav-text">dispatch_once</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dispatch_I/O"><span class="nav-number">2.6.</span> <span class="nav-text">Dispatch I/O</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp; 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Yt</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>



<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="theme-info">
  <span id="busuanzi_container_site_uv">
    &nbsp&nbsp&nbsp&nbsp|&nbsp&nbsp Total <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> views.
您是本站的第<span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span>个小伙伴
<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Hits
  </span>
<div>
      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js"></script>


  <script type="text/javascript" src="/js/helpers.js"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js" id="motion.global"></script>




  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  
  

  

    
      
    

    <script type="text/javascript">
      var disqus_shortname = 'ytlvy';
      var disqus_identifier = '2015/06/07/IOS-Multithreading-Memory-Management/';
      var disqus_title = 'IOS Multithreading && Memory Management';
      var disqus_url = 'http://ytlvy.com/2015/06/07/IOS-Multithreading-Memory-Management/';

      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  




  
  

</body>
</html>
